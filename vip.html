<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pro Universal IPTV Player - Tüm Formatlar İçin</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/webrtc-adapter/out/adapter.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<style>
  :root {
    --primary-color: #00a8ff;
    --primary-hover: #0097e6;
    --danger-color: #e84118;
    --danger-hover: #c23616;
    --success-color: #4cd137;
    --success-hover: #44bd32;
    --secondary-color: #718093;
    --secondary-hover: #5f6b7d;
    --bg-dark: #1e272e;
    --bg-darker: #151d24;
    --bg-panel: #2f3640;
    --bg-controls: #353b48;
    --text-light: #f5f6fa;
    --text-muted: #dcdde1;
    --border-color: #3d484f;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --player-height: 56.25vw; /* 16:9 aspect ratio */
    --max-player-height: 70vh;
    --mobile-font-size: 14px;
    --desktop-font-size: 16px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    background: var(--bg-dark);
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    line-height: 1.6;
    font-size: var(--mobile-font-size);
  }

  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    src: url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2) format('woff2');
    unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }

  header {
    background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
    padding: 12px 15px;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    box-shadow: var(--shadow);
    z-index: 10;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
  }

  .logo-icon {
    font-size: 1.3rem;
    color: var(--primary-color);
  }

  .status {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Mobil Tasarım */
  @media (max-width: 768px) {
    body {
      font-size: var(--mobile-font-size);
    }
    
    header {
      padding: 10px 12px;
      font-size: 0.9rem;
    }
    
    .logo-icon {
      font-size: 1.1rem;
    }
    
    .status {
      font-size: 0.7rem;
    }
    
    main {
      flex-direction: column;
    }
    
    #channelPanel {
      width: 100%;
      max-height: 30vh;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    #player {
      padding: 10px;
    }
    
    #playlistControls {
      flex-direction: column;
    }
    
    #playlistControls select, 
    #playlistControls button {
      width: 100%;
      font-size: 0.9rem;
      padding: 10px;
    }
    
    .player-container {
      max-height: calc(var(--player-height) - 10px);
    }
    
    .channel-name {
      font-size: 0.9rem;
    }
    
    .icons span {
      font-size: 1rem;
    }
    
    #filters {
      padding: 10px;
      flex-direction: row;
      flex-wrap: wrap;
    }
    
    #filters select, #filters input {
      flex: 1 1 45%;
      min-width: 120px;
      font-size: 0.8rem;
      padding: 8px;
    }
    
    .mobile-nav-btn {
      font-size: 0.7rem;
      padding: 3px;
    }
    
    .mobile-nav-btn i {
      font-size: 1rem;
    }
  }

  /* Tablet ve Daha Büyük Ekranlar */
  @media (min-width: 769px) {
    body {
      font-size: var(--desktop-font-size);
    }
    
    main {
      flex-direction: row;
    }
    
    #channelPanel {
      width: 280px;
      height: 100%;
    }
    
    #player {
      flex: 1;
      padding: 15px;
    }
  }

  /* Büyük Ekranlar */
  @media (min-width: 1200px) {
    header {
      font-size: 1.3rem;
      padding: 15px 20px;
    }
    
    #channelPanel {
      width: 320px;
    }
    
    #filters select, 
    #filters input,
    #playlistControls select,
    #playlistControls button,
    #controls input,
    #controls button {
      font-size: 1rem;
      padding: 12px;
    }
    
    .channel-name {
      font-size: 1rem;
    }
  }

  /* Çok Büyük Ekranlar */
  @media (min-width: 1920px) {
    header {
      font-size: 1.5rem;
      padding: 20px 30px;
    }
    
    #channelPanel {
      width: 350px;
    }
  }

  #channelPanel {
    background: var(--bg-panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-right: 1px solid var(--border-color);
  }

  #filters {
    padding: 12px;
    display: flex;
    gap: 8px;
    background: var(--bg-darker);
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
  }

  select, input[type="search"], input[type="text"] {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-controls);
    color: var(--text-light);
    font-size: inherit;
    cursor: pointer;
    transition: var(--transition);
    width: 100%;
  }

  select:focus, input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 168, 255, 0.3);
  }

  #channelCount {
    padding: 10px 12px;
    font-size: 0.85rem;
    color: var(--text-muted);
    background: var(--bg-darker);
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
  }

  .refresh-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
    font-size: 1rem;
    padding: 2px;
  }

  .refresh-btn:hover {
    color: var(--primary-color);
    transform: rotate(180deg);
  }

  #channelList {
    list-style: none;
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) var(--bg-controls);
  }

  #channelList::-webkit-scrollbar {
    width: 6px;
  }

  #channelList::-webkit-scrollbar-track {
    background: var(--bg-controls);
  }

  #channelList::-webkit-scrollbar-thumb {
    background-color: var(--primary-color);
    border-radius: 3px;
    border: 1px solid var(--bg-controls);
  }

  #channelList li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
  }

  #channelList li:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  #channelList li.active {
    background-color: rgba(0, 168, 255, 0.15);
    border-left: 3px solid var(--primary-color);
  }

  #channelList img {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    object-fit: contain;
    flex-shrink: 0;
    background: var(--bg-controls);
    padding: 2px;
  }

  .channel-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
  }

  .icons {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-left: auto;
    font-size: 1rem;
  }

  .icons span {
    cursor: pointer;
    user-select: none;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
  }

  .icons span:hover {
    transform: scale(1.2);
  }

  section#player {
    display: flex;
    flex-direction: column;
    padding: 12px;
    overflow-y: auto;
    background: var(--bg-dark);
    position: relative;
    flex: 1;
  }

  .player-container {
    position: relative;
    width: 100%;
    height: calc(var(--player-height));
    max-height: var(--max-player-height);
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  video, audio {
    width: 100%;
    height: 100%;
    max-height: 100%;
    background: black;
    display: none;
    outline: none;
  }

  video {
    object-fit: contain;
  }

  .player-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    z-index: 2;
    opacity: 0;
    transition: var(--transition);
  }

  .player-container:hover .player-overlay {
    opacity: 1;
  }

  .player-info {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 0.7rem;
    z-index: 3;
  }

  .player-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 15px;
    z-index: 3;
    opacity: 0;
    transition: var(--transition);
  }

  .player-container:hover .player-controls {
    opacity: 1;
  }

  .control-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
  }

  .control-btn:hover {
    background: var(--primary-color);
    transform: scale(1.1);
  }

  .playlist-manager {
    background: var(--bg-panel);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
  }

  .playlist-manager h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--text-light);
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .playlist-manager h3::before {
    content: "📋";
  }

  #playlistControls {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  #playlistControls select {
    flex: 1;
    min-width: 200px;
  }

  #playlistControls button {
    padding: 10px 15px;
    border: none;
    color: #fff;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: inherit;
  }

  #playlistControls button i {
    font-size: 1rem;
  }

  #playlistControls button:not(.secondary):not(.danger) {
    background: var(--primary-color);
  }

  #playlistControls button:not(.secondary):not(.danger):hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
  }

  #playlistControls button.secondary {
    background: var(--secondary-color);
  }

  #playlistControls button.secondary:hover {
    background: var(--secondary-hover);
    transform: translateY(-2px);
  }

  #playlistControls button.danger {
    background: var(--danger-color);
  }

  #playlistControls button.danger:hover {
    background: var(--danger-hover);
    transform: translateY(-2px);
  }

  #controls {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  #controls input[type="text"] {
    flex: 1;
    min-width: 200px;
  }

  #controls button {
    background: var(--primary-color);
    border: none;
    color: #fff;
    padding: 10px 15px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: inherit;
  }

  #controls button:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
  }

  #controls button i {
    font-size: 1rem;
  }

  /* Animations */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading {
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    margin: 15px auto;
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    bottom: 15px;
    right: 15px;
    background: var(--bg-panel);
    color: var(--text-light);
    padding: 12px 16px;
    border-radius: 6px;
    box-shadow: var(--shadow);
    z-index: 1000;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: 90%;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success {
    border-left: 3px solid var(--success-color);
  }

  .toast.error {
    border-left: 3px solid var(--danger-color);
  }

  .toast.warning {
    border-left: 3px solid #fbc531;
  }

  /* Context menu */
  .context-menu {
    position: absolute;
    background: var(--bg-panel);
    border-radius: 6px;
    box-shadow: var(--shadow);
    z-index: 100;
    min-width: 180px;
    overflow: hidden;
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.2s ease;
    pointer-events: none;
  }

  .context-menu.show {
    transform: scale(1);
    opacity: 1;
    pointer-events: all;
  }

  .context-menu-item {
    padding: 10px 12px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .context-menu-item:hover {
    background: var(--primary-color);
  }

  /* Progress bar */
  .progress-container {
    width: 100%;
    height: 3px;
    background: var(--bg-controls);
    position: relative;
    margin-top: 8px;
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Subtitles */
  .subtitle-container {
    position: absolute;
    bottom: 40px;
    left: 0;
    right: 0;
    text-align: center;
    z-index: 3;
    pointer-events: none;
  }

  .subtitle {
    display: inline-block;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 1rem;
    max-width: 80%;
  }

  /* Touch controls */
  .touch-controls {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    z-index: 2;
  }

  .touch-left, .touch-right {
    flex: 1;
    height: 100%;
  }

  /* VPN indicator */
  .vpn-indicator {
    position: fixed;
    bottom: 60px;
    right: 15px;
    background: var(--bg-panel);
    color: var(--text-light);
    padding: 8px 12px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
  }

  .vpn-on {
    color: var(--success-color);
  }

  .vpn-off {
    color: var(--danger-color);
  }

  /* Mobile bottom navigation */
  .mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-darker);
    padding: 8px;
    z-index: 100;
    border-top: 1px solid var(--border-color);
  }

  .mobile-nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    padding: 5px;
    border-radius: 5px;
    transition: var(--transition);
    font-size: 0.7rem;
  }

  .mobile-nav-btn.active {
    color: var(--primary-color);
    background: rgba(0, 168, 255, 0.1);
  }

  .mobile-nav-btn i {
    margin-bottom: 3px;
  }

  @media (max-width: 768px) {
    .mobile-nav {
      display: flex;
    }
    
    main {
      padding-bottom: 60px;
    }
  }

  /* YouTube player style */
  .youtube-player {
    width: 100%;
    height: 100%;
    display: none;
  }

  /* Adaptive quality selector */
  .quality-selector {
    position: absolute;
    bottom: 50px;
    right: 10px;
    background: var(--bg-panel);
    border-radius: 5px;
    overflow: hidden;
    z-index: 4;
    box-shadow: var(--shadow);
    display: none;
  }

  .quality-option {
    padding: 8px 12px;
    cursor: pointer;
    transition: var(--transition);
  }

  .quality-option:hover {
    background: var(--primary-color);
  }

  .quality-option.active {
    background: var(--primary-hover);
    color: white;
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <span class="logo-icon">📺</span>
    <span>Pro Universal IPTV</span>
  </div>
  <div class="status">
    <span class="status-indicator"></span>
    <span id="connectionStatus">Çevrimiçi</span>
  </div>
</header>
<main>
  <aside id="channelPanel">
    <div id="filters">
      <select id="favSelect">
        <option value="Tümü">Favoriler: Tümü</option>
        <option value="Favorilerim">Favorilerim</option>
      </select>
      <select id="countrySelect">
        <option value="Tümü">Ülke: Tümü</option>
      </select>
      <select id="categorySelect">
        <option value="Tümü">Kategori: Tümü</option>
      </select>
      <input type="search" id="searchInput" placeholder="Kanal ara..." />
    </div>
    <div id="channelCount">
      <span>Kanallar: <span id="channelCountNum">0</span></span>
      <button class="refresh-btn" title="Listeyi Yenile">↻</button>
    </div>
    <ul id="channelList"></ul>
  </aside>
  <section id="player">
    <div class="player-container">
      <video id="video" controls autoplay playsinline></video>
      <audio id="audio" controls autoplay></audio>
      <div id="youtubePlayer" class="youtube-player"></div>
      
      <div class="player-overlay">
        <button class="control-btn fullscreen-btn">⛶</button>
      </div>
      
      <div class="player-controls">
        <button class="control-btn skip-backward">⏪</button>
        <button class="control-btn toggle-play">⏯</button>
        <button class="control-btn skip-forward">⏩</button>
      </div>
      
      <div class="player-info" id="playerInfo"></div>
      <div class="subtitle-container" id="subtitleContainer"></div>
      
      <div class="touch-controls">
        <div class="touch-left"></div>
        <div class="touch-right"></div>
      </div>
      
      <div class="quality-selector" id="qualitySelector"></div>
    </div>
    
    <div class="playlist-manager">
      <h3>Playlist Yönetimi</h3>
      <div id="playlistControls">
        <select id="playlistSelect">
          <option value="">Playlist Seçin</option>
        </select>
        <button id="newPlaylistBtn" class="new-playlist" data-tooltip="Yeni playlist oluştur">
          <span>+</span> Yeni
        </button>
        <button id="renamePlaylistBtn" class="rename-playlist secondary" data-tooltip="Playlist adını değiştir">
          <span>✏️</span> Yeniden Adlandır
        </button>
        <button id="savePlaylistBtn" class="save-playlist secondary" data-tooltip="Değişiklikleri kaydet">
          <span>💾</span> Kaydet
        </button>
        <button id="deletePlaylistBtn" class="delete-playlist danger" data-tooltip="Playlisti sil">
          <span>🗑️</span> Sil
        </button>
        <button id="cloudPlaylistBtn" class="cloud-playlist secondary" data-tooltip="Buluttan playlist yükle">
          <span>☁️</span> Bulut
        </button>
      </div>
      <div id="controls">
        <input type="text" id="urlInput" placeholder="M3U URL, yayın linki veya YouTube URL girin..." />
        <button id="loadUrlBtn" class="load-url" data-tooltip="URL'den kanal ekle">
          <span>🌐</span> URL Yükle
        </button>
        <button id="loadFileBtn" class="load-file" data-tooltip="Yerel dosyadan ekle">
          <span>📁</span> Yerel Dosya
        </button>
        <input type="file" id="fileInput" accept=".m3u,.m3u8,.mp3,.mp4,.avi,.webm,.ts,.flv,.mkv" style="display:none" />
      </div>
      <div class="progress-container" id="progressContainer" style="display:none">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </section>
</main>

<div class="mobile-nav">
  <div class="mobile-nav-btn active" data-section="player">
    <span>📺</span>
    <span>Oynatıcı</span>
  </div>
  <div class="mobile-nav-btn" data-section="channels">
    <span>📋</span>
    <span>Kanallar</span>
  </div>
  <div class="mobile-nav-btn" data-section="playlists">
    <span>🎵</span>
    <span>Playlistler</span>
  </div>
  <div class="mobile-nav-btn toggle-vpn">
    <span>🔒</span>
    <span>VPN</span>
  </div>
</div>

<div id="toast" class="toast"></div>
<div id="vpnIndicator" class="vpn-indicator" style="display:none">
  <span id="vpnStatusIcon" class="vpn-off">🔒</span>
  <span id="vpnStatusText">VPN: Kapalı</span>
</div>

<script>
  // Değişkenler
  const video = document.getElementById('video');
  const audio = document.getElementById('audio');
  const youtubePlayer = document.getElementById('youtubePlayer');
  const channelListEl = document.getElementById('channelList');
  const fileInput = document.getElementById('fileInput');
  const urlInput = document.getElementById('urlInput');
  const countrySelect = document.getElementById('countrySelect');
  const categorySelect = document.getElementById('categorySelect');
  const searchInput = document.getElementById('searchInput');
  const channelCount = document.getElementById('channelCountNum');
  const favSelect = document.getElementById('favSelect');
  const playlistSelect = document.getElementById('playlistSelect');
  const playerInfo = document.getElementById('playerInfo');
  const toast = document.getElementById('toast');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const connectionStatus = document.getElementById('connectionStatus');
  const subtitleContainer = document.getElementById('subtitleContainer');
  const qualitySelector = document.getElementById('qualitySelector');
  const vpnIndicator = document.getElementById('vpnIndicator');
  const vpnStatusIcon = document.getElementById('vpnStatusIcon');
  const vpnStatusText = document.getElementById('vpnStatusText');

  // Butonlar
  const newPlaylistBtn = document.getElementById('newPlaylistBtn');
  const renamePlaylistBtn = document.getElementById('renamePlaylistBtn');
  const savePlaylistBtn = document.getElementById('savePlaylistBtn');
  const deletePlaylistBtn = document.getElementById('deletePlaylistBtn');
  const cloudPlaylistBtn = document.getElementById('cloudPlaylistBtn');
  const loadUrlBtn = document.getElementById('loadUrlBtn');
  const loadFileBtn = document.getElementById('loadFileBtn');
  const refreshBtn = document.querySelector('.refresh-btn');
  const fullscreenBtn = document.querySelector('.fullscreen-btn');
  const skipBackwardBtn = document.querySelector('.skip-backward');
  const skipForwardBtn = document.querySelector('.skip-forward');
  const togglePlayBtn = document.querySelector('.toggle-play');
  const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
  const toggleVpnBtn = document.querySelector('.toggle-vpn');

  let playlists = {};
  let currentPlaylistName = '';
  let channels = [];
  let filteredChannels = [];
  let currentChannelIndex = null;
  let hls = null;
  let dashPlayer = null;
  let flvPlayer = null;
  let passwords = JSON.parse(localStorage.getItem('channelPasswords') || '{}');
  let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  let bufferTimer = null;
  let networkCheckInterval = null;
  let touchTimer = null;
  let currentSubtitles = null;
  let vpnActive = false;
  let youtubePlayerInstance = null;

  // Yardımcı Fonksiyonlar
  function showToast(message, type = 'success', duration = 3000) {
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
      toast.classList.remove('show');
    }, duration);
  }

  function showError(message) {
    console.error(message);
    showToast(`Hata: ${message}`, 'error', 5000);
  }

  function sanitize(input) {
    if (!input) return '';
    return input.toString()
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function formatSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
  }

  function toggleFullscreen() {
    const player = document.querySelector('.player-container');
    if (!document.fullscreenElement) {
      player.requestFullscreen().catch(err => {
        showError(`Tam ekran hatası: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  function checkNetworkStatus() {
    if (navigator.onLine) {
      connectionStatus.textContent = 'Çevrimiçi';
      document.querySelector('.status-indicator').style.background = 'var(--success-color)';
    } else {
      connectionStatus.textContent = 'Çevrimdışı';
      document.querySelector('.status-indicator').style.background = 'var(--danger-color)';
    }
  }

  // Dokunmatik Kontroller
  function handleTouchStartLeft(e) {
    e.preventDefault();
    touchTimer = setTimeout(() => {
      skipBackward();
    }, 300);
  }

  function handleTouchStartRight(e) {
    e.preventDefault();
    touchTimer = setTimeout(() => {
      skipForward();
    }, 300);
  }

  function handleTouchEnd(e) {
    e.preventDefault();
    if (touchTimer) {
      clearTimeout(touchTimer);
      touchTimer = null;
    }
  }

  function skipBackward() {
    if (video.style.display === 'block') {
      video.currentTime = Math.max(0, video.currentTime - 10);
    } else if (audio.style.display === 'block') {
      audio.currentTime = Math.max(0, audio.currentTime - 10);
    }
  }

  function skipForward() {
    if (video.style.display === 'block') {
      video.currentTime = Math.min(video.duration, video.currentTime + 10);
    } else if (audio.style.display === 'block') {
      audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
    }
  }

  function togglePlayPause() {
    if (video.style.display === 'block') {
      video.paused ? video.play() : video.pause();
    } else if (audio.style.display === 'block') {
      audio.paused ? audio.play() : audio.pause();
    }
  }

  // Mobil Navigasyon
  function showSection(section) {
    mobileNavBtns.forEach(btn => btn.classList.remove('active'));
    
    document.querySelector(`.mobile-nav-btn[data-section="${section}"]`).classList.add('active');
    
    if (section === 'player') {
      document.getElementById('channelPanel').style.display = 'none';
      document.getElementById('player').style.display = 'flex';
    } else if (section === 'channels') {
      document.getElementById('channelPanel').style.display = 'flex';
      document.getElementById('player').style.display = 'none';
    } else if (section === 'playlists') {
      document.getElementById('channelPanel').style.display = 'none';
      document.getElementById('player').style.display = 'flex';
    }
  }

  // VPN Fonksiyonları
  function toggleVPN() {
    vpnActive = !vpnActive;
    updateVPNStatus();
    
    if (vpnActive) {
      showToast('VPN bağlantısı sağlanıyor...', 'success');
      setTimeout(() => {
        showToast('VPN bağlantısı başarılı!', 'success');
      }, 1500);
    } else {
      showToast('VPN bağlantısı kesildi', 'warning');
    }
  }

  function updateVPNStatus() {
    if (vpnActive) {
      vpnIndicator.style.display = 'flex';
      vpnStatusIcon.className = 'vpn-on';
      vpnStatusIcon.textContent = '🔓';
      vpnStatusText.textContent = 'VPN: Açık';
    } else {
      vpnStatusIcon.className = 'vpn-off';
      vpnStatusIcon.textContent = '🔒';
      vpnStatusText.textContent = 'VPN: Kapalı';
    }
  }

  // YouTube Player Fonksiyonları
  function initYouTubePlayer(videoId) {
    if (youtubePlayerInstance) {
      youtubePlayerInstance.destroy();
    }
    
    youtubePlayerInstance = new YT.Player('youtubePlayer', {
      height: '100%',
      width: '100%',
      videoId: videoId,
      playerVars: {
        'autoplay': 1,
        'controls': 1,
        'modestbranding': 1,
        'rel': 0
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  function onPlayerReady(event) {
    event.target.playVideo();
  }

  function onPlayerStateChange(event) {
    // YouTube player state changes
  }

  function clearPlayers() {
    if(hls) {
      hls.destroy();
      hls = null;
    }
    if(dashPlayer) {
      dashPlayer.reset();
      dashPlayer = null;
    }
    if(flvPlayer) {
      flvPlayer.destroy();
      flvPlayer = null;
    }
    if(youtubePlayerInstance) {
      youtubePlayerInstance.destroy();
      youtubePlayerInstance = null;
    }
    video.src = '';
    audio.src = '';
  }

  // Playlist yönetim fonksiyonları
  function loadPlaylistsFromStorage() {
    try {
      const savedPlaylists = localStorage.getItem('playlists');
      if (savedPlaylists) {
        playlists = JSON.parse(savedPlaylists);
      } else {
        // Varsayılan playlist oluştur
        playlists = {
          'Ana Playlist': []
        };
        savePlaylistsToStorage();
      }
    } catch (e) {
      showError(`Playlist yüklenirken hata: ${e.message}`);
    }
  }

  function savePlaylistsToStorage() {
    try {
      localStorage.setItem('playlists', JSON.stringify(playlists));
      localStorage.setItem('lastPlaylist', currentPlaylistName);
      updatePlaylistDropdown();
    } catch (e) {
      showError(`Playlist kaydedilirken hata: ${e.message}`);
    }
  }

  function updatePlaylistDropdown() {
    try {
      playlistSelect.innerHTML = '<option value="">Playlist Seçin</option>';
      Object.keys(playlists).sort().forEach(name => {
        const selected = name === currentPlaylistName ? 'selected' : '';
        playlistSelect.insertAdjacentHTML('beforeend', 
          `<option value="${sanitize(name)}" ${selected}>${sanitize(name)} (${playlists[name].length})</option>`);
      });
    } catch (e) {
      showError(`Playlist listesi güncellenirken hata: ${e.message}`);
    }
  }

  function loadSelectedPlaylist() {
    try {
      const selectedName = playlistSelect.value;
      if (!selectedName) return;
      
      currentPlaylistName = selectedName;
      loadPlaylist(playlists[selectedName]);
      savePlaylistsToStorage();
      showToast(`"${selectedName}" playlisti yüklendi`);
    } catch (e) {
      showError(`Playlist yüklenirken hata: ${e.message}`);
    }
  }

  function loadPlaylist(playlistData) {
    try {
      if (playlistData && playlistData.length > 0) {
        channels = [...playlistData];
      } else {
        channels = [];
      }
      filteredChannels = [...channels];
      fillFilters();
      filterChannels();
      
      // Bu playlistten son oynatılan kanalı açmayı dene
      const lastPlayedIndex = localStorage.getItem(`lastPlayedIndex_${currentPlaylistName}`);
      if (lastPlayedIndex !== null && !isNaN(lastPlayedIndex) && channels[lastPlayedIndex]) {
        playChannel(parseInt(lastPlayedIndex));
      }
    } catch (e) {
      showError(`Playlist yüklenirken hata: ${e.message}`);
    }
  }

  function showNewPlaylistDialog() {
    try {
      const name = prompt('Yeni playlist adı girin:');
      if (!name) return;
      
      const cleanName = sanitize(name.trim());
      if (!cleanName) {
        showError('Geçerli bir playlist adı girin!');
        return;
      }
      
      if (playlists[cleanName]) {
        showError('Bu isimde bir playlist zaten var!');
        return;
      }
      
      playlists[cleanName] = [];
      currentPlaylistName = cleanName;
      playlistSelect.value = cleanName;
      channels = [];
      filteredChannels = [];
      filterChannels();
      savePlaylistsToStorage();
      showToast(`"${cleanName}" playlisti oluşturuldu`);
    } catch (e) {
      showError(`Yeni playlist oluşturulurken hata: ${e.message}`);
    }
  }

  function showRenamePlaylistDialog() {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin!');
        return;
      }
      
      const newName = prompt('Yeni playlist adı girin:', currentPlaylistName);
      if (!newName || newName === currentPlaylistName) return;
      
      const cleanName = sanitize(newName.trim());
      if (!cleanName) {
        showError('Geçerli bir playlist adı girin!');
        return;
      }
      
      if (playlists[cleanName]) {
        showError('Bu isimde bir playlist zaten var!');
        return;
      }
      
      playlists[cleanName] = [...playlists[currentPlaylistName]];
      delete playlists[currentPlaylistName];
      currentPlaylistName = cleanName;
      savePlaylistsToStorage();
      showToast(`Playlist adı "${cleanName}" olarak değiştirildi`);
    } catch (e) {
      showError(`Playlist adı değiştirilirken hata: ${e.message}`);
    }
  }

  function saveCurrentPlaylist() {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin veya oluşturun!');
        return;
      }
      
      playlists[currentPlaylistName] = [...channels];
      savePlaylistsToStorage();
      showToast('Playlist başarıyla kaydedildi!');
    } catch (e) {
      showError(`Playlist kaydedilirken hata: ${e.message}`);
    }
  }

  function confirmDeletePlaylist() {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin!');
        return;
      }
      
      if (confirm(`"${currentPlaylistName}" playlistini silmek istediğinize emin misiniz?`)) {
        delete playlists[currentPlaylistName];
        
        // Başka bir playlist seç (eğer varsa)
        const remaining = Object.keys(playlists);
        if (remaining.length > 0) {
          currentPlaylistName = remaining[0];
          loadPlaylist(playlists[currentPlaylistName]);
        } else {
          // Son playlist silindiyse yeni boş bir playlist oluştur
          currentPlaylistName = 'Yeni Playlist';
          playlists[currentPlaylistName] = [];
          channels = [];
          filteredChannels = [];
          filterChannels();
        }
        
        savePlaylistsToStorage();
        showToast(`"${currentPlaylistName}" playlisti silindi`);
      }
    } catch (e) {
      showError(`Playlist silinirken hata: ${e.message}`);
    }
  }

  function loadCloudPlaylist() {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin veya oluşturun!');
        return;
      }
      
      showToast('Bulut bağlantısı kuruluyor...', 'success');
      
      setTimeout(() => {
        const simulatedPlaylist = [
          {
            name: "TRT 1",
            url: "https://trtcanlitv-lh.akamaihd.net/i/TRT1HD_1@181842/master.m3u8",
            group: "Genel",
            country: "Türkiye",
            logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/TRT_1_logo.png/640px-TRT_1_logo.png"
          },
          {
            name: "CNN Türk",
            url: "https://live.duhnet.tv/S2/HLS_LIVE/cnnturk/1000/prog_index.m3u8",
            group: "Haber",
            country: "Türkiye",
            logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/CNN_T%C3%BCrk_logo.svg/640px-CNN_T%C3%BCrk_logo.svg.png"
          }
        ];
        
        channels = [...channels, ...simulatedPlaylist];
        filteredChannels = channels;
        filterChannels();
        playlists[currentPlaylistName] = channels;
        savePlaylistsToStorage();
        showToast('Buluttan 2 kanal eklendi');
      }, 1500);
    } catch (e) {
      showError(`Bulut bağlantısı sırasında hata: ${e.message}`);
    }
  }

  // Kanal işlemleri
  function savePasswords() {
    try {
      localStorage.setItem('channelPasswords', JSON.stringify(passwords));
    } catch (e) {
      showError(`Şifreler kaydedilirken hata: ${e.message}`);
    }
  }
  
  function saveFavorites() {
    try {
      localStorage.setItem('favorites', JSON.stringify(favorites));
    } catch (e) {
      showError(`Favoriler kaydedilirken hata: ${e.message}`);
    }
  }

  function parseM3U(text) {
    try {
      const lines = text.split(/\r?\n/);
      const result = [];
      
      for(let i = 0; i < lines.length; i++) {
        if(lines[i].startsWith('#EXTINF')) {
          const info = lines[i];
          const url = lines[i+1];
          if(!url) continue;
          
          const nameMatch = info.match(/,(.*)/);
          const groupMatch = info.match(/group-title="([^"]+)"/);
          const countryMatch = info.match(/tvg-country="([^"]+)"/);
          const logoMatch = info.match(/tvg-logo="([^"]+)"/);
          const idMatch = info.match(/tvg-id="([^"]+)"/);
          
          const name = nameMatch ? sanitize(nameMatch[1].trim()) : 'İsimsiz Kanal';
          const group = groupMatch ? sanitize(groupMatch[1].trim()) : 'Genel';
          const country = countryMatch ? sanitize(countryMatch[1].trim()) : 'Bilinmiyor';
          const logo = logoMatch ? sanitize(logoMatch[1].trim()) : 
                   'https://cdn-icons-png.flaticon.com/512/727/727245.png';
          const tvgId = idMatch ? sanitize(idMatch[1].trim()) : '';
          
          if(url.trim().startsWith('http')) {
            result.push({
              name,
              url: url.trim(),
              group,
              country,
              logo,
              tvgId
            });
          }
        }
      }
      return result;
    } catch (e) {
      showError(`M3U ayrıştırılırken hata: ${e.message}`);
      return [];
    }
  }

  function fillFilters() {
    try {
      const countries = new Set();
      const categories = new Set();
      
      channels.forEach(channel => {
        if (channel.country) countries.add(channel.country);
        if (channel.group) categories.add(channel.group);
      });
      
      countrySelect.innerHTML = '<option value="Tümü">Ülke: Tümü</option>';
      categorySelect.innerHTML = '<option value="Tümü">Kategori: Tümü</option>';
      
      Array.from(countries).sort().forEach(c => {
        countrySelect.insertAdjacentHTML('beforeend', `<option value="${sanitize(c)}">${sanitize(c)}</option>`);
      });
      
      Array.from(categories).sort().forEach(c => {
        categorySelect.insertAdjacentHTML('beforeend', `<option value="${sanitize(c)}">${sanitize(c)}</option>`);
      });
    } catch (e) {
      showError(`Filtreler doldurulurken hata: ${e.message}`);
    }
  }

  function refreshChannels() {
    filterChannels();
    showToast('Kanal listesi yenilendi');
  }

  function filterChannels() {
    try {
      const favoriteFilter = favSelect.value;
      const country = countrySelect.value;
      const category = categorySelect.value;
      const search = searchInput.value.trim().toLowerCase();

      filteredChannels = channels.filter(channel => {
        const favoriteCondition = favoriteFilter === 'Favorilerim' ? favorites.includes(channel.url) : true;
        const countryCondition = country === 'Tümü' || channel.country === country;
        const categoryCondition = category === 'Tümü' || channel.group === category;
        const searchCondition = channel.name.toLowerCase().includes(search) || 
                          (channel.tvgId && channel.tvgId.toLowerCase().includes(search));
        return favoriteCondition && countryCondition && categoryCondition && searchCondition;
      });
      
      displayChannels();
    } catch (e) {
      showError(`Kanallar filtrelenirken hata: ${e.message}`);
    }
  }

  function displayChannels() {
    try {
      channelListEl.innerHTML = '';
      
      if (channels.length === 0) {
        channelListEl.innerHTML = '<li style="justify-content:center; padding:20px; color:var(--text-muted)">Henüz kanal eklenmedi</li>';
        channelCount.textContent = '0';
        return;
      }
      
      if (filteredChannels.length === 0) {
        channelListEl.innerHTML = '<li style="justify-content:center; padding:20px; color:var(--text-muted)">Filtreyle eşleşen kanal bulunamadı</li>';
      }
      
      filteredChannels.forEach((channel, idx) => {
        const li = document.createElement('li');
        if(channels.indexOf(channel) === currentChannelIndex) li.classList.add('active');

        const img = document.createElement('img');
        img.src = channel.logo || 'https://cdn-icons-png.flaticon.com/512/727/727245.png';
        img.alt = channel.name;
        img.onerror = () => {
          img.src = 'https://cdn-icons-png.flaticon.com/512/727/727245.png';
        };

        const nameSpan = document.createElement('span');
        nameSpan.className = 'channel-name';
        nameSpan.textContent = `${channels.indexOf(channel) + 1}. ${channel.name}`;

        const iconsDiv = document.createElement('div');
        iconsDiv.className = 'icons';

        // Favori ikonu
        const favoriteSpan = document.createElement('span');
        favoriteSpan.title = favorites.includes(channel.url) ? 'Favorilerden çıkar' : 'Favorilere ekle';
        favoriteSpan.textContent = favorites.includes(channel.url) ? '★' : '☆';
        favoriteSpan.onclick = e => {
          e.stopPropagation();
          try {
            if(favorites.includes(channel.url)) {
              favorites = favorites.filter(f => f !== channel.url);
              showToast('Favorilerden çıkarıldı');
            } else {
              favorites.push(channel.url);
              showToast('Favorilere eklendi');
            }
            saveFavorites();
            displayChannels();
          } catch (e) {
            showError(`Favori işlemi sırasında hata: ${e.message}`);
          }
        };

        // Kilit ikonu
        const lockSpan = document.createElement('span');
        lockSpan.title = passwords[channel.url] ? 'Şifreli Kanal - Şifreyi Değiştir/Denetle' : 'Şifre Ekle';
        lockSpan.textContent = passwords[channel.url] ? '🔒' : '🔓';
        lockSpan.onclick = e => {
          e.stopPropagation();
          try {
            if(passwords[channel.url]) {
              const input = prompt('Bu kanal şifreli. Lütfen şifreyi girin:');
              if(input === passwords[channel.url]) {
                playChannel(channels.indexOf(channel));
              } else {
                showError('Şifre yanlış!');
              }
            } else {
              const newPassword = prompt('Bu kanala 4 haneli şifre belirleyin (sadece rakam):');
              if(/^\d{4}$/.test(newPassword)) {
                passwords[channel.url] = newPassword;
                savePasswords();
                displayChannels();
                showToast('Şifre başarıyla ayarlandı');
              } else {
                showError('Geçerli bir 4 haneli şifre girin!');
              }
            }
          } catch (e) {
            showError(`Şifre işlemi sırasında hata: ${e.message}`);
          }
        };

        // Format ikonu
        const extension = channel.url.split('.').pop().toLowerCase();
        const formatSpan = document.createElement('span');
        formatSpan.title = `Format: ${extension}`;
        if(extension === 'm3u8') formatSpan.textContent = '📺';
        else if(extension === 'mp3') formatSpan.textContent = '🎵';
        else if(['mp4','avi','webm','ts','flv','mkv'].includes(extension)) formatSpan.textContent = '🎞️';
        else formatSpan.textContent = '❓';

        iconsDiv.appendChild(favoriteSpan);
        iconsDiv.appendChild(lockSpan);
        iconsDiv.appendChild(formatSpan);

        li.appendChild(img);
        li.appendChild(nameSpan);
        li.appendChild(iconsDiv);

        li.onclick = () => {
          try {
            if(passwords[channel.url]) {
              const input = prompt('Bu kanal şifreli. Lütfen şifreyi girin:');
              if(input === passwords[channel.url]) {
                playChannel(channels.indexOf(channel));
              } else {
                showError('Şifre yanlış!');
              }
            } else {
              playChannel(channels.indexOf(channel));
            }
          } catch (e) {
            showError(`Kanal oynatılırken hata: ${e.message}`);
          }
        };

        channelListEl.appendChild(li);
      });
      
      channelCount.textContent = filteredChannels.length;
    } catch (e) {
      showError(`Kanallar gösterilirken hata: ${e.message}`);
    }
  }

  function playChannel(index) {
    try {
      const channel = channels[index];
      if(!channel) return;

      currentChannelIndex = index;
      localStorage.setItem(`lastPlayedIndex_${currentPlaylistName}`, index);

      // Önceki oynatıcıyı temizle
      clearPlayers();
      
      video.style.display = 'none';
      audio.style.display = 'none';
      youtubePlayer.style.display = 'none';
      playerInfo.textContent = `Yükleniyor: ${channel.name}`;

      // YouTube linki kontrolü
      const youtubeMatch = channel.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|youtu\.be\/)([^"&?\/\s]{11})/i);
      if (youtubeMatch && youtubeMatch[1]) {
        youtubePlayer.style.display = 'block';
        initYouTubePlayer(youtubeMatch[1]);
        playerInfo.textContent = `YouTube: ${channel.name}`;
        filterChannels();
        return;
      }

      const url = new URL(channel.url, window.location.href);
      const extension = channel.url.split('.').pop().toLowerCase();
      const protocol = channel.url.split(':')[0].toLowerCase();

      // Yükleme durumunu göster
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if(progress > 90) clearInterval(progressInterval);
        progressBar.style.width = `${progress}%`;
      }, 200);

      // Oynatma işlemi
      const playbackCompleted = () => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 500);
      };

      // Format algılama
      const format = detectStreamFormat(channel.url);
      
      if(format === 'hls') {
        // HLS akışı
        if(typeof Hls !== 'undefined' && Hls.isSupported()) {
          hls = new Hls({
            maxBufferLength: 30,
            maxMaxBufferLength: 600,
            maxBufferSize: 60 * 1000 * 1000,
            maxBufferHole: 0.5,
            lowLatencyMode: true,
            backBufferLength: 30
          });
          hls.loadSource(channel.url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            // Adaptif bitrate için kalite seçici göster
            showQualitySelector(hls.levels);
            video.play().catch(e => {
              showError(`Video oynatılamadı: ${e.message}`);
            });
            playbackCompleted();
          });
          hls.on(Hls.Events.ERROR, (event, data) => {
            if(data.fatal) {
              switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  showError('Ağ hatası - sunucuya bağlanılamıyor');
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  showError('Medya hatası - format desteklenmiyor olabilir');
                  break;
                default:
                  showError('HLS oynatma hatası');
                  break;
              }
              hls.destroy();
            }
          });
          video.style.display = 'block';
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari için yerel HLS desteği
          video.src = channel.url;
          video.style.display = 'block';
          video.addEventListener('loadedmetadata', playbackCompleted);
          video.play().catch(e => {
            showError(`Video oynatılamadı: ${e.message}`);
          });
        } else {
          showError('Tarayıcı bu HLS formatını desteklemiyor.');
        }
      } else if(format === 'dash') {
        // MPEG-DASH akışı
        if(typeof dashjs !== 'undefined') {
          dashPlayer = dashjs.MediaPlayer().create();
          dashPlayer.initialize(video, channel.url, true);
          dashPlayer.updateSettings({
            streaming: {
              buffer: {
                bufferTimeAtTopQuality: 20,
                bufferTimeAtTopQualityLongForm: 20,
                bufferAheadToKeep: 20,
                maxBufferLength: 30,
                initialBufferLevel: 10,
                fastSwitchEnabled: true
              }
            }
          });
          video.style.display = 'block';
          playbackCompleted();
        } else {
          showError('DASH oynatıcı yüklenemedi');
        }
      } else if(format === 'flv') {
        // FLV/RTMP akışı
        if(typeof flvjs !== 'undefined' && flvjs.isSupported()) {
          flvPlayer = flvjs.createPlayer({
            type: 'flv',
            url: channel.url,
            isLive: true
          }, {
            enableWorker: true,
            enableStashBuffer: false,
            stashInitialSize: 128
          });
          flvPlayer.attachMediaElement(video);
          flvPlayer.load();
          flvPlayer.play();
          video.style.display = 'block';
          playbackCompleted();
        } else {
          showError('FLV oynatıcı yüklenemedi');
        }
      } else if(['mp3','ogg','wav','aac'].includes(format)) {
        // Ses dosyaları
        audio.src = channel.url;
        audio.style.display = 'block';
        audio.addEventListener('loadedmetadata', playbackCompleted);
        audio.play().catch(e => {
          showError(`Ses oynatılamadı: ${e.message}`);
        });
      } else {
        // Diğer video formatları (MP4, AVI, MKV vb.)
        video.src = channel.url;
        video.style.display = 'block';
        video.addEventListener('loadedmetadata', playbackCompleted);
        video.play().catch(e => {
          showError(`Video oynatılamadı: ${e.message}`);
        });
      }
      
      // Otomatik altyazı yükleme (Türkçe ve İngilizce)
      loadSubtitles(channel);
      
      filterChannels();
    } catch (e) {
      showError(`Kanal oynatılırken hata: ${e.message}`);
    }
  }

  function detectStreamFormat(url) {
    const lowerUrl = url.toLowerCase();
    
    if (lowerUrl.includes('.m3u8') || lowerUrl.includes('hls')) {
      return 'hls';
    } else if (lowerUrl.includes('.mpd') || lowerUrl.includes('dash')) {
      return 'dash';
    } else if (lowerUrl.includes('.flv') || lowerUrl.includes('rtmp')) {
      return 'flv';
    } else if (lowerUrl.includes('.mp3') || lowerUrl.includes('.ogg') || lowerUrl.includes('.wav') || lowerUrl.includes('.aac')) {
      return lowerUrl.split('.').pop();
    } else if (lowerUrl.includes('.mp4') || lowerUrl.includes('.webm') || lowerUrl.includes('.mkv') || lowerUrl.includes('.avi')) {
      return 'video';
    }
    
    // Varsayılan olarak HLS deneyelim
    return 'hls';
  }

  function showQualitySelector(levels) {
    if (!levels || levels.length < 2) return;
    
    qualitySelector.innerHTML = '';
    levels.forEach((level, index) => {
      const option = document.createElement('div');
      option.className = 'quality-option';
      option.textContent = `${level.height}p`;
      option.onclick = () => {
        hls.currentLevel = index;
        qualitySelector.style.display = 'none';
      };
      qualitySelector.appendChild(option);
    });
    
    qualitySelector.style.display = 'block';
    setTimeout(() => {
      qualitySelector.style.display = 'none';
    }, 5000);
  }

  function loadSubtitles(channel) {
    // Basit altyazı yükleme simülasyonu
    subtitleContainer.innerHTML = '';
    currentSubtitles = null;
    
    // Örnek altyazılar (gerçek uygulamada bu bir API'den veya dosyadan yüklenebilir)
    const exampleSubtitles = [
      { time: 0, text: "Merhaba dünya!", lang: "tr" },
      { time: 2, text: "Hello world!", lang: "en" },
      { time: 5, text: "Bu bir test yayınıdır", lang: "tr" },
      { time: 5, text: "This is a test broadcast", lang: "en" }
    ];
    
    currentSubtitles = exampleSubtitles;
    
    // Video zaman güncellemelerini dinle
    video.addEventListener('timeupdate', updateSubtitles);
  }

  function updateSubtitles() {
    if (!currentSubtitles || !video) return;
    
    const currentTime = video.currentTime;
    const subtitle = currentSubtitles.find(sub => 
      sub.time <= currentTime && sub.time + 3 >= currentTime
    );
    
    subtitleContainer.innerHTML = '';
    
    if (subtitle) {
      const subtitleElement = document.createElement('div');
      subtitleElement.className = 'subtitle';
      subtitleElement.textContent = subtitle.text;
      subtitleContainer.appendChild(subtitleElement);
    }
  }

  function loadFromURL() {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin veya oluşturun!');
        return;
      }
      
      const url = urlInput.value.trim();
      if(!url) {
        showError('Lütfen bir URL girin!');
        return;
      }
      
      // Yükleme durumunu göster
      const oldText = urlInput.placeholder;
      urlInput.placeholder = 'Yükleniyor...';
      urlInput.disabled = true;
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if(progress > 90) clearInterval(progressInterval);
        progressBar.style.width = `${progress}%`;
      }, 200);

      if(url.endsWith('.m3u') || url.endsWith('.m3u8')) {
        fetch(url)
          .then(res => {
            if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
            return res.text();
          })
          .then(data => {
            const parsed = parseM3U(data);
            channels = [...channels, ...parsed];
            filteredChannels = channels;
            fillFilters();
            filterChannels();
            
            // URL'den yükleme yapıldığında otomatik kaydet
            playlists[currentPlaylistName] = channels;
            savePlaylistsToStorage();
            showToast(`${parsed.length} kanal eklendi`);
          })
          .catch(e => {
            showError(`Playlist yüklenemedi: ${e.message}`);
          })
          .finally(() => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            setTimeout(() => {
              progressContainer.style.display = 'none';
            }, 500);
            urlInput.placeholder = oldText;
            urlInput.disabled = false;
            urlInput.value = '';
          });
      } else {
        const name = prompt('Bu yayına bir isim verin:') || 'Özel Yayın';
        channels.push({
          name: sanitize(name),
          url: url,
          group: 'Özel',
          country: 'Bilinmiyor',
          logo: 'https://cdn-icons-png.flaticon.com/512/727/727245.png'
        });
        filteredChannels = channels;
        filterChannels();
        
        // Kanal eklendiğinde otomatik kaydet
        playlists[currentPlaylistName] = channels;
        savePlaylistsToStorage();
        showToast('Kanal başarıyla eklendi');
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 500);
        urlInput.placeholder = oldText;
        urlInput.disabled = false;
        urlInput.value = '';
      }
    } catch (e) {
      showError(`URL yüklenirken hata: ${e.message}`);
      urlInput.placeholder = oldText;
      urlInput.disabled = false;
    }
  }

  function loadFile(e) {
    try {
      if (!currentPlaylistName) {
        showError('Önce bir playlist seçin veya oluşturun!');
        return;
      }
      
      const file = e.target.files[0];
      if(!file) return;

      const extension = file.name.split('.').pop().toLowerCase();
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if(progress > 90) clearInterval(progressInterval);
        progressBar.style.width = `${progress}%`;
      }, 200);

      if(extension === 'm3u' || extension === 'm3u8') {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = parseM3U(reader.result);
            channels = [...channels, ...parsed];
            filteredChannels = channels;
            fillFilters();
            filterChannels();
            
            // Dosyadan yükleme yapıldığında otomatik kaydet
            playlists[currentPlaylistName] = channels;
            savePlaylistsToStorage();
            showToast(`${parsed.length} kanal eklendi`);
          } catch (e) {
            showError(`Dosya okunurken hata: ${e.message}`);
          } finally {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            setTimeout(() => {
              progressContainer.style.display = 'none';
            }, 500);
          }
        };
        reader.onerror = () => {
          showError('Dosya okuma hatası!');
          clearInterval(progressInterval);
          progressBar.style.width = '100%';
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 500);
        };
        reader.readAsText(file);
      } else {
        // Video/ses dosyası - yerel blob URL ile oynat
        const url = URL.createObjectURL(file);
        channels.push({
          name: sanitize(file.name),
          url,
          group: 'Yerel',
          country: 'Bilgisayar',
          logo: 'https://cdn-icons-png.flaticon.com/512/727/727245.png'
        });
        filteredChannels = channels;
        filterChannels();
        
        // Yerel dosya eklendiğinde otomatik kaydet
        playlists[currentPlaylistName] = channels;
        savePlaylistsToStorage();
        showToast('Yerel dosya eklendi');
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 500);
        fileInput.value = null;
      }
    } catch (e) {
      showError(`Dosya yüklenirken hata: ${e.message}`);
    }
  }

  // Oynatıcıyı başlat
  function initializePlayer() {
    try {
      // Ağ durumunu kontrol et
      checkNetworkStatus();
      networkCheckInterval = setInterval(checkNetworkStatus, 5000);
      window.addEventListener('online', checkNetworkStatus);
      window.addEventListener('offline', checkNetworkStatus);

      // Playlistleri yükle
      loadPlaylistsFromStorage();
      updatePlaylistDropdown();
      
      // Son kullanılan playlisti yüklemeyi dene
      const lastPlaylist = localStorage.getItem('lastPlaylist');
      if (lastPlaylist && playlists[lastPlaylist]) {
        currentPlaylistName = lastPlaylist;
        playlistSelect.value = lastPlaylist;
        loadPlaylist(playlists[lastPlaylist]);
      }

      // Video olaylarını dinle
      video.addEventListener('playing', () => {
        playerInfo.textContent = `Oynatılıyor: ${channels[currentChannelIndex]?.name || 'Bilinmeyen'}`;
      });

      video.addEventListener('waiting', () => {
        playerInfo.textContent = `Tamponlanıyor...`;
      });

      video.addEventListener('error', (e) => {
        showError(`Video oynatma hatası: ${video.error?.message || 'Bilinmeyen hata'}`);
      });

      audio.addEventListener('error', (e) => {
        showError(`Ses oynatma hatası: ${audio.error?.message || 'Bilinmeyen hata'}`);
      });

      // Klavye kısayolları
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
        
        switch(e.key) {
          case 'ArrowUp':
            if (currentChannelIndex !== null && currentChannelIndex > 0) {
              playChannel(currentChannelIndex - 1);
            }
            break;
          case 'ArrowDown':
            if (currentChannelIndex !== null && currentChannelIndex < channels.length - 1) {
              playChannel(currentChannelIndex + 1);
            }
            break;
          case 'f':
          case 'F':
            toggleFullscreen();
            break;
          case ' ':
            togglePlayPause();
            break;
          case 'm':
          case 'M':
            if (video.style.display === 'block') {
              video.muted = !video.muted;
            } else if (audio.style.display === 'block') {
              audio.muted = !audio.muted;
            }
            break;
        }
      });

      // Buton event listener'ları
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      skipBackwardBtn.addEventListener('click', skipBackward);
      skipForwardBtn.addEventListener('click', skipForward);
      togglePlayBtn.addEventListener('click', togglePlayPause);
      
      document.querySelector('.touch-left').addEventListener('touchstart', handleTouchStartLeft);
      document.querySelector('.touch-left').addEventListener('touchend', handleTouchEnd);
      document.querySelector('.touch-right').addEventListener('touchstart', handleTouchStartRight);
      document.querySelector('.touch-right').addEventListener('touchend', handleTouchEnd);
      
      refreshBtn.addEventListener('click', refreshChannels);
      
      favSelect.addEventListener('change', filterChannels);
      countrySelect.addEventListener('change', filterChannels);
      categorySelect.addEventListener('change', filterChannels);
      searchInput.addEventListener('input', filterChannels);
      
      playlistSelect.addEventListener('change', loadSelectedPlaylist);
      newPlaylistBtn.addEventListener('click', showNewPlaylistDialog);
      renamePlaylistBtn.addEventListener('click', showRenamePlaylistDialog);
      savePlaylistBtn.addEventListener('click', saveCurrentPlaylist);
      deletePlaylistBtn.addEventListener('click', confirmDeletePlaylist);
      cloudPlaylistBtn.addEventListener('click', loadCloudPlaylist);
      
      loadUrlBtn.addEventListener('click', loadFromURL);
      loadFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', loadFile);
      
      mobileNavBtns.forEach(btn => {
        btn.addEventListener('click', () => showSection(btn.dataset.section));
      });
      
      toggleVpnBtn.addEventListener('click', toggleVPN);

      showToast('Oynatıcı başlatıldı', 'success');
    } catch (e) {
      showError(`Oynatıcı başlatılırken hata: ${e.message}`);
    }
  }

  // Sayfa yüklendiğinde oynatıcıyı başlat
  document.addEventListener('DOMContentLoaded', initializePlayer);

  // Sayfa kapanırken verileri kaydet
  window.addEventListener('beforeunload', () => {
    try {
      if (currentPlaylistName && channels.length) {
        playlists[currentPlaylistName] = channels;
        savePlaylistsToStorage();
      }
      savePasswords();
      saveFavorites();
      if (networkCheckInterval) clearInterval(networkCheckInterval);
    } catch (e) {
      console.error('Çıkış sırasında hata:', e);
    }
  });

  // Android geri tuşu için kontrol
  document.addEventListener('backbutton', () => {
    if (confirm('Uygulamadan çıkmak istediğinize emin misiniz?')) {
      navigator.app.exitApp();
    }
  }, false);
</script>
</body>
</html>
